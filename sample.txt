ENV NEXUS_CREDS=${NEXUS_CREDS}
RUN mkdir -p /usr/share/maven/conf/

# Copy settings.xml for Nexus+Central
COPY settings.xml /usr/share/maven/conf/settings.xml

---
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <modelVersion>4.0.0</modelVersion>

    <groupId>com.sbc.fctm.gsna</groupId>
    <artifactId>gcp-jenkins-shared-lib</artifactId>
    <version>1.1.0</version>
    <packaging>zip</packaging>

    <!-- REQUIRED FOR DEPLOY WITHOUT USERNAME/PASSWORD -->
    <build>
        <extensions>
            <!-- Enables Maven Wagon HTTP (needed for Token / ServiceAccount auth) -->
            <extension>
                <groupId>org.apache.maven.wagon</groupId>
                <artifactId>wagon-http</artifactId>
                <version>3.5.2</version>
            </extension>
        </extensions>

        <plugins>

            <!-- 1. PACKAGE YOUR ZIP LIBRARY -->
            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <version>3.3.0</version>
                <executions>
                    <execution>
                        <id>make-shared-lib</id>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                        <configuration>
                            <!-- IMPORTANT: You said your assembly.xml is at this path -->
                            <descriptors>
                                <descriptor>assembly.xml</descriptor>
                            </descriptors>

                            <finalName>${project.artifactId}-${project.version}</finalName>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- 2. DEPLOY ZIP TO NEXUS USING MAVEN -->
            <plugin>
                <artifactId>maven-deploy-plugin</artifactId>
                <version>3.1.1</version>
                <configuration>
                    <skip>false</skip>
                </configuration>
            </plugin>

        </plugins>
    </build>

    <!-- 3. WHERE MAVEN WILL DEPLOY (NO ENV VARS, HARDCODED) -->
    <distributionManagement>
        <repository>
            <id>nexus3</id>
            <url>https://nexus306.system.uk.sbc:8081/nexus/repository/maven-sbc-internal-dev_n3p/</url>
        </repository>
    </distributionManagement>

</project>

---

<assembly xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 
  http://maven.apache.org/xsd/assembly-1.1.3.xsd">

  <id>lib</id>
  <formats>
    <format>zip</format>
  </formats>

  <includeBaseDirectory>false</includeBaseDirectory>

  <fileSets>
    <fileSet>
      <directory>.</directory>
      <outputDirectory>/</outputDirectory>
      <includes>
        <include>vars/**</include>
        <include>src/**</include>
        <include>resources/**</include>
        <include>version.txt</include>
      </includes>
    </fileSet>
  </fileSets>
</assembly>
---

<settings>
  <servers>
    <server>
      <id>nexus3</id>
      <username>${env.NEXUS_CREDS}</username>
      <password>${env.NEXUS_CREDS}</password>
    </server>
  </servers>

  <mirrors>
    <mirror>
      <id>internal-nexus</id>
      <mirrorOf>central</mirrorOf>
      <url>https://nexus306.system.uk.sbc:8081/nexus/repository/maven-sbc-internal-dev_n3p/</url>
    </mirror>
  </mirrors>

  <profiles>
    <profile>
      <id>internal-profile</id>

      <repositories>
        <repository>
          <id>nexus3</id>
          <url>https://nexus306.system.uk.sbc:8081/nexus/repository/maven-sbc-internal-dev_n3p/</url>
        </repository>

        <repository>
          <id>central</id>
          <url>https://repo.maven.apache.org/maven2/</url>
        </repository>
      </repositories>

    </profile>
  </profiles>

  <activeProfiles>
    <activeProfile>internal-profile</activeProfile>
  </activeProfiles>
</settings>
---
steps:

# 1. Clone shared lib repository
- name: gcr.io/cloud-builders/git
  entrypoint: bash
  args:
    - -c
    - |
      git clone https://github.com/your-org/gcp-jenkins-shared-lib.git
      cd gcp-jenkins-shared-lib
      ls -R

# 2. Maven package ZIP
- name: maven:3.9.6-eclipse-temurin-17
  entrypoint: bash
  args:
    - -c
    - |
      cd gcp-jenkins-shared-lib
      mvn -B clean package

# 3. Upload ZIP â†’ Nexus (using token = NEXUS3_CREDS)
- name: curlimages/curl
  entrypoint: bash
  args:
    - -c
    - |
      ARTIFACT=gcp-jenkins-shared-lib-1.1.0.zip

      curl -X PUT \
        -H "Authorization: Bearer ${NEXUS3_CREDS}" \
        --upload-file target/${ARTIFACT} \
        "https://nexus306.system.uk.sbc:8081/nexus/repository/maven-sbc-internal-dev_n3p/com/sbc/fctm/gsna/shared_lib/1.1.0/${ARTIFACT}"

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/NEXUS3_CREDS/versions/latest
      env: NEXUS3_CREDS
