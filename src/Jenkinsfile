pipeline {
    agent any

    environment {
        GIT_REPO_URL = "https://github.com/yourorg/your-shared-library.git"
        BRANCH = "main"
        ZIP_NAME = "shared-library.zip"

        NEXUS_URL = "http://<nexus-host>:8081/repository/<your-repo>/"
        NEXUS_USER = "service-user"
        NEXUS_PASS = "service-password"
    }

    stages {

        stage('Install Git + Zip') {
            steps {
                script {
                    if (isUnix()) {
                        sh '''
                            echo "Installing git + zip on Linux..."
                            if command -v apt-get >/dev/null; then
                                sudo apt-get update -y
                                sudo apt-get install -y git zip
                            elif command -v yum >/dev/null; then
                                sudo yum install -y git zip
                            else
                                echo "Unsupported Linux OS"
                                exit 1
                            fi
                        '''
                    } else {
                        bat '''
                            echo Installing Git on Windows...
                            where git
                            if %errorlevel% neq 0 (
                                powershell -Command "winget install --id Git.Git -e --accept-source-agreements --accept-package-agreements"
                            )
                            echo Ensuring zip is available...
                            powershell -Command "Add-Type -AssemblyName System.IO.Compression.FileSystem"
                        '''
                    }
                }
            }
        }

        stage('Clone Shared Library Repo') {
            steps {
                script {
                    if (isUnix()) {
                        sh '''
                            echo "Cloning on Linux..."
                            rm -rf shared-library || true
                            git clone -b ${BRANCH} ${GIT_REPO_URL} shared-library
                        '''
                    } else {
                        bat '''
                            echo Cloning on Windows...
                            rmdir /S /Q shared-library 2>nul
                            git clone -b %BRANCH% %GIT_REPO_URL% shared-library
                        '''
                    }
                }
            }
        }

        stage('Zip Repo') {
            steps {
                script {
                    if (isUnix()) {
                        sh '''
                            echo "Zipping on Linux..."
                            rm -f ${ZIP_NAME}
                            zip -r ${ZIP_NAME} shared-library
                        '''
                    } else {
                        bat '''
                            echo Zipping on Windows...
                            if exist %ZIP_NAME% del %ZIP_NAME%
                            powershell -Command "Compress-Archive -Path shared-library -DestinationPath %ZIP_NAME%"
                        '''
                    }
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                script {
                    if (isUnix()) {
                        sh '''
                            echo "Uploading on Linux..."
                            curl -v -u ${NEXUS_USER}:${NEXUS_PASS} \
                                --upload-file ${ZIP_NAME} \
                                ${NEXUS_URL}${ZIP_NAME}
                        '''
                    } else {
                        bat '''
                            echo Uploading on Windows...
                            curl -v -u %NEXUS_USER%:%NEXUS_PASS% ^
                                --upload-file %ZIP_NAME% ^
                                %NEXUS_URL%%ZIP_NAME%
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Done! Repo cloned, zipped, and uploaded to Nexus."
        }
        failure {
            echo "Pipeline failed â€” check logs."
        }
    }
}
