pipeline {
    agent any

    environment {
        GITHUB_REPO_ZIP = "https://github.com/<org>/<repo>/archive/refs/heads/main.zip"
        DOWNLOAD_ZIP    = "repo.zip"
        EXTRACT_DIR     = "repo"
        FINAL_ZIP       = "shared-lib.zip"
        NEXUS_URL       = "https://nexus.com/repository/raw-repo/"
        NEXUS_CRED      = "nexus-creds"
    }

    stages {

        stage('Download Shared Library from GitHub (NO GIT)') {
            steps {
                script {
                    if (isUnix()) {
                        sh """
                            rm -f ${DOWNLOAD_ZIP}
                            curl -L ${GITHUB_REPO_ZIP} -o ${DOWNLOAD_ZIP}
                        """
                    } else {
                        bat """
                            curl -L ${GITHUB_REPO_ZIP} -o ${DOWNLOAD_ZIP}
                        """
                    }
                }
            }
        }

        stage('Extract ZIP') {
            steps {
                script {
                    if (isUnix()) {
                        sh """
                            rm -rf ${EXTRACT_DIR}
                            unzip ${DOWNLOAD_ZIP} -d ${EXTRACT_DIR}
                        """
                    } else {
                        bat """
                            rmdir /S /Q ${EXTRACT_DIR} 2>nul
                            powershell -Command "Expand-Archive -Path ${DOWNLOAD_ZIP} -DestinationPath ${EXTRACT_DIR} -Force"
                        """
                    }
                }
            }
        }

        stage('Re-Zip for Nexus Upload') {
            steps {
                script {
                    if (isUnix()) {
                        sh """
                            rm -f ${FINAL_ZIP}
                            cd ${EXTRACT_DIR}
                            zip -r ../${FINAL_ZIP} .
                        """
                    } else {
                        bat """
                            del ${FINAL_ZIP} 2>nul
                            powershell -Command "Compress-Archive -Path ${EXTRACT_DIR}\\* -DestinationPath ${FINAL_ZIP} -Force"
                        """
                    }
                }
            }
        }

        stage('Upload ZIP to Nexus') {
            steps {
                withCredentials([
                    usernamePassword(credentialsId: NEXUS_CRED, usernameVariable: 'USER', passwordVariable: 'PASS')
                ]) {
                    script {
                        if (isUnix()) {
                            sh """
                                curl -u $USER:$PASS --upload-file ${FINAL_ZIP} ${NEXUS_URL}${FINAL_ZIP}
                            """
                        } else {
                            bat """
                                curl -u %USER%:%PASS% --upload-file ${FINAL_ZIP} ${NEXUS_URL}${FINAL_ZIP}
                            """
                        }
                    }
                }
            }
        }
    }
}
